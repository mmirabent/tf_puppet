#cloud-config

# Write the file to a tmp directory then copy it later to the users home. If you
# copy to the users home dir now, the user won't get the .bashrc and .profile
# files in their home dir
write_files:
  - encoding: b64
    content: "${ssh_priv}"
    path: "/run/ssh_tmp/id_rsa"
    permissions: "0600"

# If we try to set ownership in write_files, we will fail because the users are
# created after the write files step. To get around that, we use good old runcmd
runcmd:
  - [ yum, update, -y ]
  - [ mv, "/run/ssh_tmp/id_rsa", "/home/${user}/.ssh/id_rsa" ]
  - [ chown,  -vR, "${user}:${user}", "/home/${user}/.ssh/id_rsa"]

preserve_hostname: false
hostname: ${hostname}
fqdn: ${hostname}.local
manage_etc_hosts: true